name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  backend:
    runs-on: ubuntu-latest
    env:
      STORAGE_PATH: ${{ github.workspace }}/storage
      EVIDENCE_PATH: ${{ github.workspace }}/storage/evidence
      EVENTS_DATA_PATH: ${{ github.workspace }}/00_data/Track2/raw_data.csv
      MATCH_INFO_PATH: ${{ github.workspace }}/00_data/Track2/match_info.csv
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Prepare backend paths
        run: |
          mkdir -p "${STORAGE_PATH}"
          mkdir -p "${EVIDENCE_PATH}"
          mkdir -p "$(dirname "${EVENTS_DATA_PATH}")"

      - name: Install dependencies
        run: pip install -r backend/requirements.txt && pip install pytest

      - name: Compile backend
        run: python -m compileall backend

      - name: Import smoke test
        run: PYTHONPATH=backend python -c "from app.main import app; print('import-ok')"

      - name: Run backend tests
        run: pytest -q backend

  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Check lockfile sync
        run: node ../scripts/check_lockfile_sync.js

      - name: Install dependencies
        run: npm ci --include=dev

      - name: Build frontend
        run: npm run build
